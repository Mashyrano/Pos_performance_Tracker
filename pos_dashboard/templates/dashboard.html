{% extends 'base.html' %}
{% block content %}
<h1>Dashboard</h1>
<form id="date-form" method="GET" action="#">
    <label for="start_date">Start Date:</label>
    <input type="date" id="start_date" name="start_date" required>
    <label for="end_date">End Date:</label>
    <input type="date" id="end_date" name="end_date" required>
    <button type="button" onclick="fetchDashboardData()">Fetch Data</button>
</form>

<div>
    <canvas id="volumeZiGChart" width="400" height="200"></canvas>
    <canvas id="valueZiGChart" width="400" height="200"></canvas>
    <canvas id="volumeUSDChart" width="400" height="200"></canvas>
    <canvas id="valueUSDChart" width="400" height="200"></canvas>
</div>

<h2>Activity Ratio</h2>
<table border="1">
    <tr>
        <th>Group</th>
        <th>ZiG Activity Ratio (%)</th>
        <th>USD Activity Ratio (%)</th>
    </tr>
    <tbody id="activityRatioTableBody">
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0/dist/chartjs-plugin-datalabels.min.js"></script>

<script>

const BACKEND_URL = 'http://localhost:5002';

function fetchDashboardData() {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;

    if (startDate && endDate) {
        fetch(`${BACKEND_URL}/dashboard/data?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                renderCharts(data);
                renderActivityRatioTable(data);
            })
            .catch(error => {
                console.error('Error fetching dashboard data:', error);
                alert('Failed to fetch dashboard data.');
            });
    } else {
        alert('Please select a start date and end date.');
    }
}

function renderCharts(data) {
    const groupNames = Object.keys(data);
    const totalVolumeZiG = groupNames.map(group => data[group].total_volume_zig);
    const totalValueZiG = groupNames.map(group => data[group].total_value_zig);
    const totalVolumeUSD = groupNames.map(group => data[group].total_volume_usd);
    const totalValueUSD = groupNames.map(group => data[group].total_value_usd);

    const volumeZiGCtx = document.getElementById('volumeZiGChart').getContext('2d');
    const valueZiGCtx = document.getElementById('valueZiGChart').getContext('2d');
    const volumeUSDCtx = document.getElementById('volumeUSDChart').getContext('2d');
    const valueUSDCtx = document.getElementById('valueUSDChart').getContext('2d');

    new Chart(volumeZiGCtx, {
        type: 'bar',
        data: {
            labels: groupNames,
            datasets: [
                { label: 'ZiG Volume', data: totalVolumeZiG, backgroundColor: 'rgba(75, 192, 192, 0.6)' }
            ]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: {
                datalabels: {
                    display: true,
                    color: 'black'
                }
            }
        }
    });

    new Chart(valueZiGCtx, {
        type: 'bar',
        data: {
            labels: groupNames,
            datasets: [
                { label: 'ZiG Value', data: totalValueZiG, backgroundColor: 'rgba(75, 192, 192, 0.6)' }
            ]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: {
                datalabels: {
                    display: true,
                    color: 'black'
                }
            }
        }
    });

    new Chart(volumeUSDCtx, {
        type: 'bar',
        data: {
            labels: groupNames,
            datasets: [
                { label: 'USD Volume', data: totalVolumeUSD, backgroundColor: 'rgba(153, 102, 255, 0.6)' }
            ]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: {
                datalabels: {
                    display: true,
                    color: 'black'
                }
            }
        }
    });

    new Chart(valueUSDCtx, {
        type: 'bar',
        data: {
            labels: groupNames,
            datasets: [
                { label: 'USD Value', data: totalValueUSD, backgroundColor: 'rgba(153, 102, 255, 0.6)' }
            ]
        },
        options: {
            scales: { y: { beginAtZero: true } },
            plugins: {
                datalabels: {
                    display: true,
                    color: 'black'
                }
            }
        }
    });
}

function renderActivityRatioTable(data) {
    const tableBody = document.getElementById('activityRatioTableBody');
    tableBody.innerHTML = ''; // Clear the table

    const groupNames = Object.keys(data);
    groupNames.forEach(group => {
        const row = document.createElement('tr');
        const groupCell = document.createElement('td');
        const zigCell = document.createElement('td');
        const usdCell = document.createElement('td');

        groupCell.textContent = group;
        zigCell.textContent = (data[group].activity_ratio_zig * 100).toFixed(2) + '%';
        usdCell.textContent = (data[group].activity_ratio_usd * 100).toFixed(2) + '%';

        row.appendChild(groupCell);
        row.appendChild(zigCell);
        row.appendChild(usdCell);
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %}
